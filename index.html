<!doctype html>
<html>

<head>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
</head>

<body>
  <p>
    You can run llama2-py in Pyodide
  </p>
  <ul>
    <li>https://github.com/takano32/pyodide-llama2-py</li>
    <li>https://github.com/pyodide/pyodide</li>
    <li>https://github.com/tairov/llama2.py</li>
  </ul>
  <input id="code" style="width: 100%;" value="Dream comes true this day" />
  <button onclick="evaluatePython()">Run</button>
  <br />
  <br />
  <div>Output:</div>
  <textarea id="output" style="width: 100%;" rows="23" disabled></textarea>

  <script>
    const output = document.getElementById("output");
    const code = document.getElementById("code");

    function addToOutput(s) {
      output.value += "Prompt: " + code.value + "\n" + s + "\n";
    }

    output.value = "Initializing...\n";
    // init Pyodide
    async function main() {
      let package_list = [
        "llama2-py",
      ];
      let pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip");
      const micropip = pyodide.pyimport("micropip");
      await micropip.install(package_list);

      /*
      const modelResponse = await fetch("./stories15M.bin");
      const modelArrayBuffer = await modelResponse.arrayBuffer();
      await pyodide.FS.writeFile("stories15M.bin", modelArrayBuffer);

      const tokenizerResponse = await fetch("./tokenizer.bin");
      const tokenizerArrayBuffer = await tokenizerResponse.arrayBuffer();
      await pyodide.FS.writeFile("tokenizer.bin", tokenizerArrayBuffer);
      */

      await pyodide.runPython([
        `from pyodide.http import open_url`,
        `stories_url = "./stories15M.bin"`,
        `tokenizer_url = "./tokenizer.bin"`,
        `with open("stories15M.bin", mode='wb') as f:`,
        `    buf = open_url(stories_url)`,
        `    f.write(buf.read().encode())`,
        `with open("tokenizer.bin", mode='wb') as f:`,
        `    buf = open_url(tokenizer_url)`,
        `    f.write(buf.read().encode())`,
      ].join("\n"));

      output.value += "Ready!\n";
      return pyodide;
    }
    let pyodideReadyPromise = main();

    async function evaluatePython() {
      let pyodide = await pyodideReadyPromise;
      try {
        let output = await pyodide.runPython([
          `import llama2_py`,
          `prompt = "${code.value}"`,
          `reply = llama2_py.run({"checkpoint": "stories15M.bin", "temperature": 0.0, "steps": 256, "prompt": prompt})`,
          `reply`,
        ].join("\n"));
        addToOutput(output);
      } catch (err) {
        addToOutput(err);
      }
    }
  </script>
</body>

</html>